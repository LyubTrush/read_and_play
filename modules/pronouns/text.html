<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Игра: Истории с притяжательными местоимениями</title>
    <style>
      /* Общие стили из предыдущей игры */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #c2e1db, #e8f4f1);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }

      .game-container {
        width: 100%;
        max-width: 900px;
        background: white;
        border-radius: 25px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
      }

      .level-select-screen {
        padding: 40px;
        text-align: center;
      }

      .game-title {
        font-size: 36px;
        font-weight: 700;
        color: #e57140;
        margin-bottom: 10px;
      }

      .game-subtitle {
        font-size: 18px;
        color: #666;
        margin-bottom: 40px;
      }

      .levels-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .level-card {
        background: #f7f1e5;
        border-radius: 20px;
        padding: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 3px solid transparent;
      }

      .level-card:hover {
        transform: translateY(-5px);
        border-color: #e57140;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .level-number {
        font-size: 24px;
        font-weight: 700;
        color: #e57140;
        margin-bottom: 10px;
      }

      .level-name {
        font-size: 18px;
        font-weight: 600;
        color: #3f413e;
        margin-bottom: 15px;
      }

      .level-words {
        font-size: 14px;
        color: #666;
        line-height: 1.4;
      }

      .back-button {
        background: #aed7d1;
        color: white;
        border: none;
        border-radius: 25px;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background: #9bc7c0;
        transform: translateY(-2px);
      }

      .game-screen {
        display: none;
        padding: 30px;
        text-align: center;
      }

      .game-header {
        margin-bottom: 25px;
        position: relative;
      }

      .sound-toggle {
        position: absolute;
        top: 0;
        right: 0;
        background: #f7f1e5;
        border: none;
        border-radius: 20px;
        padding: 8px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 600;
        color: #3f413e;
      }

      .instruction {
        font-size: 22px;
        font-weight: 700;
        color: #e57140;
        margin-bottom: 20px;
        padding: 12px 25px;
        background: #fff5f0;
        border-radius: 20px;
        display: inline-block;
      }

      .level-info {
        font-size: 18px;
        color: #666;
        margin-bottom: 15px;
        font-weight: 600;
      }

      .progress-container {
        margin-bottom: 25px;
        padding: 0 10px;
      }

      .progress-dots {
        display: flex;
        justify-content: center;
        gap: 6px;
        flex-wrap: wrap;
        margin: 0 auto;
        max-width: 600px;
      }

      .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #f7f1e5;
        border: 2px solid #d3c9b5;
        transition: all 0.3s ease;
      }

      .progress-dot.current {
        border-color: #e57140;
        background: #e57140;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.2);
        }
        100% {
          transform: scale(1);
        }
      }

      /* Стили для игры с историей */
      .story-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 25px;
        margin: 20px 0;
      }

      .story-image {
        width: 250px;
        height: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f8f9fa;
        border-radius: 16px;
        border: 3px solid #e9ecef;
        overflow: hidden;
        margin-bottom: 15px;
      }

      .story-image img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
      }

      .story-text {
        font-size: 20px;
        line-height: 1.6;
        color: #3f413e;
        text-align: left;
        margin: 15px 0;
        padding: 0 20px;
      }

      .pronoun-dropdown {
        display: inline-block;
        position: relative;
        min-width: 80px;
        margin: 0 5px;
      }

      .dropdown-toggle {
        background: white;
        border: 2px dashed #e57140;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 18px;
        font-weight: 600;
        color: #e57140;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
        text-align: center;
      }

      .dropdown-toggle:hover {
        background: #fff5f0;
        border-style: solid;
      }

      .dropdown-toggle.selected {
        border-style: solid;
        background: #fff5f0;
      }

      .dropdown-toggle.correct {
        border-color: #4caf50;
        background: #e8f5e8;
        color: #22543d;
      }

      .dropdown-toggle.wrong {
        border-color: #ff6b6b;
        background: #ffebee;
        color: #742a2a;
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e57140;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        z-index: 100;
        display: none;
        flex-direction: column;
      }

      .dropdown-menu.show {
        display: flex;
      }

      .dropdown-option {
        padding: 10px 12px;
        font-size: 16px;
        font-weight: 600;
        color: #3f413e;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        background: none;
        text-align: left;
      }

      .dropdown-option:hover {
        background: #fff5f0;
      }

      .dropdown-option:not(:last-child) {
        border-bottom: 1px solid #e9ecef;
      }

      .navigation-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .nav-button {
        padding: 14px 35px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        border-radius: 25px;
      }

      .back-nav-button {
        background: #aed7d1;
        color: white;
      }

      .next-nav-button {
        background: #e57140;
        color: white;
      }

      .nav-button:hover:not(:disabled) {
        transform: translateY(-2px);
      }

      .nav-button:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }

      /* Окно результатов */
      .result-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .result-modal {
        background: white;
        border-radius: 25px;
        padding: 40px;
        text-align: center;
        max-width: 700px;
        width: 90%;
        position: relative;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      }

      .close-button {
        position: absolute;
        top: 15px;
        right: 15px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .result-title {
        font-size: 32px;
        font-weight: 700;
        color: #3f413e;
        margin-bottom: 15px;
      }

      .result-stats {
        font-size: 20px;
        color: #666;
        margin-bottom: 30px;
        font-weight: 600;
      }

      .mistakes-list {
        text-align: left;
        margin: 20px 0;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 12px;
        max-height: 400px;
        overflow-y: auto;
      }

      .mistake-item {
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #ff6b6b;
      }

      .mistake-item:last-child {
        margin-bottom: 0;
      }

      .mistake-sentence {
        font-size: 16px;
        color: #3f413e;
        line-height: 1.5;
        margin-bottom: 8px;
      }

      .mistake-answer {
        font-size: 14px;
        color: #4caf50;
        font-weight: 600;
        background: #e8f5e8;
        padding: 4px 8px;
        border-radius: 4px;
        margin-left: 5px;
      }

      .mistake-user-answer {
        font-size: 14px;
        color: #ff6b6b;
        font-weight: 600;
        background: #ffebee;
        padding: 4px 8px;
        border-radius: 4px;
        text-decoration: line-through;
        margin-right: 5px;
      }

      .answer-comparison {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .answer-label {
        font-size: 14px;
        color: #666;
        font-weight: 600;
      }

      .result-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 25px;
      }

      .result-btn {
        padding: 12px 25px;
        border: none;
        border-radius: 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-retry {
        background: #aed7d1;
        color: white;
      }

      .btn-menu {
        background: #e57140;
        color: white;
      }

      .btn-retry:hover,
      .btn-menu:hover {
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .game-container {
          margin: 10px;
        }

        .level-select-screen,
        .game-screen {
          padding: 25px 20px;
        }

        .game-title {
          font-size: 28px;
        }

        .story-text {
          font-size: 18px;
          padding: 0 10px;
        }

        .story-image {
          width: 200px;
          height: 160px;
        }

        .dropdown-toggle {
          font-size: 16px;
          padding: 5px 10px;
          min-width: 70px;
        }

        .result-modal {
          padding: 30px 20px;
        }

        .navigation-buttons {
          flex-direction: column;
          gap: 10px;
        }

        .nav-button {
          padding: 12px 25px;
          font-size: 14px;
        }
      }

      @media (max-width: 480px) {
        .story-text {
          font-size: 16px;
        }

        .dropdown-toggle {
          font-size: 14px;
          min-width: 60px;
        }

        .nav-button {
          padding: 10px 20px;
          font-size: 14px;
        }

        .mistake-item {
          padding: 10px;
        }

        .answer-comparison {
          flex-direction: column;
          align-items: flex-start;
          gap: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <!-- Экран выбора уровня -->
      <div class="level-select-screen" id="levelSelectScreen">
        <h1 class="game-title">Истории с притяжательными местоимениями</h1>
        <p class="game-subtitle">
          Заполни пропуски в рассказах притяжательными местоимениями
        </p>

        <div class="levels-grid">
          <div class="level-card" data-level="1">
            <div class="level-number">История 1</div>
            <div class="level-name">Семья и друзья Макса</div>
            <div class="level-words">my, your, his, her, our, their, its</div>
          </div>
          <div class="level-card" data-level="2">
            <div class="level-number">История 2</div>
            <div class="level-name">В парке с Эммой</div>
            <div class="level-words">my, your, his, her, our, their, its</div>
          </div>
        </div>

        <button class="back-button" onclick="window.history.back()">
          Назад
        </button>
      </div>

      <!-- Игровой экран -->
      <div class="game-screen" id="gameScreen">
        <div class="game-header">
          <button class="sound-toggle" id="soundToggle">
            <span>Звук</span>
          </button>
        </div>

        <div class="instruction">ЗАПОЛНИ ПРОПУСКИ В РАССКАЗЕ</div>
        <div class="level-info" id="levelInfo">История о семье и друзьях</div>

        <div class="progress-container">
          <div class="progress-dots" id="progressDots"></div>
        </div>

        <div class="story-container">
          <div class="story-image">
            <img id="storyImage" src="" alt="Story Image" />
          </div>

          <div class="story-text" id="storyText"></div>

          <div class="navigation-buttons">
            <button class="nav-button back-nav-button" id="backButton" disabled>
              Назад
            </button>
            <button class="nav-button next-nav-button" id="nextButton">
              Далее
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Окно результатов -->
    <div class="result-overlay" id="resultOverlay">
      <div class="result-modal">
        <button class="close-button" id="closeResult">&times;</button>
        <h2 class="result-title" id="resultTitle">Отлично!</h2>
        <div class="result-stats" id="resultStats">
          12 из 12 правильных ответов
        </div>

        <div class="mistakes-list" id="mistakesList" style="display: none">
          <h3 style="text-align: center; margin-bottom: 20px; color: #e57140">
            Работа над ошибками:
          </h3>
          <div id="mistakesContainer"></div>
        </div>

        <div class="result-buttons">
          <button class="result-btn btn-retry" id="retryButton">
            Повторить
          </button>
          <button class="result-btn btn-menu" id="menuButton">В меню</button>
        </div>
      </div>
    </div>

    <script>
      // Данные для игры
      const storiesData = {
        1: {
          title: "Семья и друзья Макса",
          parts: [
            {
              image: "../../assets/images/story/family-intro.png",
              text: "Hello! My name is Max, and this is a story about <span class='pronoun-dropdown' data-correct='my'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>my</button><button class='dropdown-option'>its</button><button class='dropdown-option'>our</button></div></span> family and friends.",
              answers: ["my"],
            },
            {
              image: "/../../assets/images/story/brother-tom.png",
              text: "This is <span class='pronoun-dropdown' data-correct='my'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>my</button><button class='dropdown-option'>your</button><button class='dropdown-option'>her</button></div></span> older brother, Tom. <span class='pronoun-dropdown' data-correct='His'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>His</button><button class='dropdown-option'>Her</button><button class='dropdown-option'>Our</button></div></span> favorite hobby is football. This is <span class='pronoun-dropdown' data-correct='his'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>his</button><button class='dropdown-option'>her</button><button class='dropdown-option'>their</button></div></span> ball.",
              answers: ["my", "His", "his"],
            },
            {
              image: "../../assets/images/story/sister-lisa.png",
              text: "And this is <span class='pronoun-dropdown' data-correct='my'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>my</button><button class='dropdown-option'>your</button><button class='dropdown-option'>our</button></div></span> sister, Lisa. This is <span class='pronoun-dropdown' data-correct='her'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>her</button><button class='dropdown-option'>his</button><button class='dropdown-option'>their</button></div></span> room. Can you see <span class='pronoun-dropdown' data-correct='her'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>her</button><button class='dropdown-option'>his</button><button class='dropdown-option'>their</button></div></span> dolls on the shelf?",
              answers: ["my", "her", "her"],
            },
            {
              image: "../../assets/images/story/dog-barney.png",
              text: "This is <span class='pronoun-dropdown' data-correct='our'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>our</button><button class='dropdown-option'>your</button><button class='dropdown-option'>their</button></div></span> dog, Barney. Look at <span class='pronoun-dropdown' data-correct='its'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>its</button><button class='dropdown-option'>their</button><button class='dropdown-option'>our</button></div></span> new toy!",
              answers: ["our", "its"],
            },
            {
              image: "../../assets/images/story/friends-bicycles.png",
              text: "Yesterday, our friends came over. These are <span class='pronoun-dropdown' data-correct='their'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>our</button><button class='dropdown-option'>your</button><button class='dropdown-option'>their</button></div></span> bicycles in the yard. We love <span class='pronoun-dropdown' data-correct='our'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>our</button><button class='dropdown-option'>your</button><button class='dropdown-option'>my</button></div></span> neighborhood!",
              answers: ["their", "our"],
            },
            {
              image: "../../assets/images/story/teacher-emily.png",
              text: "And this is <span class='pronoun-dropdown' data-correct='my'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>your</button><button class='dropdown-option'>my</button><button class='dropdown-option'>their</button></div></span> new teacher, Miss Emily. All the children love <span class='pronoun-dropdown' data-correct='her'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>her</button><button class='dropdown-option'>his</button><button class='dropdown-option'>its</button></div></span> lessons.",
              answers: ["my", "her"],
            },
          ],
        },
        2: {
          title: "В парке с Эммой",
          parts: [
            {
              image: "../../assets/images/story/park-intro.png",
              text: "Hello! My name is Emma, and this is <span class='pronoun-dropdown' data-correct='my'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>my</button><button class='dropdown-option'>your</button><button class='dropdown-option'>our</button></div></span> best friend, Lily. Today we are at <span class='pronoun-dropdown' data-correct='our'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>our</button><button class='dropdown-option'>their</button><button class='dropdown-option'>its</button></div></span> favorite park.",
              answers: ["my", "our"],
            },
            {
              image: "../../assets/images/story/lily-kite.png",
              text: "Look at Lily! This is <span class='pronoun-dropdown' data-correct='her'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>her</button><button class='dropdown-option'>his</button><button class='dropdown-option'>their</button></div></span> new yellow kite. It flies so high in <span class='pronoun-dropdown' data-correct='the'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>its</button><button class='dropdown-option'>their</button><button class='dropdown-option'>the</button></div></span> blue sky!",
              answers: ["her", "the"],
            },
            {
              image: "../../assets/images/story/toys-park.png",
              text: "And these are <span class='pronoun-dropdown' data-correct='our'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>our</button><button class='dropdown-option'>your</button><button class='dropdown-option'>their</button></div></span> toys. We always share <span class='pronoun-dropdown' data-correct='our'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>our</button><button class='dropdown-option'>my</button><button class='dropdown-option'>your</button></div></span> toys when we play together.",
              answers: ["our", "our"],
            },
            {
              image: "../../assets/images/story/boys-football.png",
              text: "Oh, look at those boys under the tree! I think that is <span class='pronoun-dropdown' data-correct='their'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>their</button><button class='dropdown-option'>our</button><button class='dropdown-option'>your</button></div></span> football. They are looking for <span class='pronoun-dropdown' data-correct='their'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>its</button><button class='dropdown-option'>their</button><button class='dropdown-option'>our</button></div></span> ball everywhere.",
              answers: ["their", "their"],
            },
            {
              image: "../../assets/images/story/mother-bench.png",
              text: "This kind woman is <span class='pronoun-dropdown' data-correct='my'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>my</button><button class='dropdown-option'>your</button><button class='dropdown-option'>their</button></div></span> mother. She is reading <span class='pronoun-dropdown' data-correct='her'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>her</button><button class='dropdown-option'>his</button><button class='dropdown-option'>its</button></div></span> book on the bench.",
              answers: ["my", "her"],
            },
            {
              image: "../../assets/images/story/dog-sparky.png",
              text: "And this is <span class='pronoun-dropdown' data-correct='our'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>our</button><button class='dropdown-option'>your</button><button class='dropdown-option'>their</button></div></span> dog, Sparky. Look! <span class='pronoun-dropdown' data-correct='Its'><button class='dropdown-toggle'>_____</button><div class='dropdown-menu'><button class='dropdown-option'>Its</button><button class='dropdown-option'>Their</button><button class='dropdown-option'>Our</button></div></span> tail is wagging so fast!",
              answers: ["our", "Its"],
            },
          ],
        },
      };

      // Элементы DOM
      const levelSelectScreen = document.getElementById("levelSelectScreen");
      const gameScreen = document.getElementById("gameScreen");
      const levelInfo = document.getElementById("levelInfo");
      const progressDots = document.getElementById("progressDots");
      const storyImage = document.getElementById("storyImage");
      const storyText = document.getElementById("storyText");
      const backButton = document.getElementById("backButton");
      const nextButton = document.getElementById("nextButton");
      const resultOverlay = document.getElementById("resultOverlay");
      const resultTitle = document.getElementById("resultTitle");
      const resultStats = document.getElementById("resultStats");
      const mistakesList = document.getElementById("mistakesList");
      const mistakesContainer = document.getElementById("mistakesContainer");
      const retryButton = document.getElementById("retryButton");
      const menuButton = document.getElementById("menuButton");
      const closeResult = document.getElementById("closeResult");

      // Переменные состояния игры
      let currentStoryId = null;
      let currentPartIndex = 0;
      let score = 0;
      let totalAnswers = 0;
      let userAnswers = [];
      let mistakes = [];
      let partAnswers = {}; // Сохраняем ответы для каждой части

      // Инициализация игры
      function initGame() {
        // Обработчики событий для выбора уровня
        document.querySelectorAll(".level-card").forEach((card) => {
          card.addEventListener("click", () => {
            const storyId = parseInt(card.getAttribute("data-level"));
            startStory(storyId);
          });
        });

        // Обработчики для кнопок
        backButton.addEventListener("click", goToPreviousPart);
        nextButton.addEventListener("click", goToNextPart);
        retryButton.addEventListener("click", retryStory);
        menuButton.addEventListener("click", goToMenu);
        closeResult.addEventListener("click", () => {
          resultOverlay.style.display = "none";
        });

        // Закрытие dropdown при клике вне его
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".pronoun-dropdown")) {
            closeAllDropdowns();
          }
        });
      }

      // Начать историю
      function startStory(storyId) {
        currentStoryId = storyId;
        currentPartIndex = 0;
        score = 0;
        totalAnswers = 0;
        userAnswers = [];
        mistakes = [];
        partAnswers = {};

        const story = storiesData[storyId];

        // Обновляем информацию об уровне
        levelInfo.textContent = story.title;

        // Создаем точки прогресса
        progressDots.innerHTML = "";
        for (let i = 0; i < story.parts.length; i++) {
          const dot = document.createElement("div");
          dot.className = "progress-dot";
          if (i === 0) dot.classList.add("current");
          progressDots.appendChild(dot);
        }

        // Показываем игровой экран
        levelSelectScreen.style.display = "none";
        gameScreen.style.display = "block";

        // Загружаем первую часть
        loadPart(currentPartIndex);
      }

      // Загрузить часть истории
      function loadPart(index) {
        const story = storiesData[currentStoryId];

        if (index >= story.parts.length) {
          showResults();
          return;
        }

        const part = story.parts[index];

        // Обновляем изображение
        storyImage.src = part.image;
        storyImage.onerror = function () {
          this.src =
            'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>';
        };

        // Обновляем текст
        storyText.innerHTML = part.text;

        // Восстанавливаем сохраненные ответы для этой части
        restoreAnswers(index);

        // Инициализируем dropdown'ы
        initDropdowns();

        // Обновляем прогресс
        updateProgressDots(index);

        // Обновляем кнопки навигации
        updateNavigationButtons();
      }

      // Восстановить сохраненные ответы
      function restoreAnswers(partIndex) {
        if (partAnswers[partIndex]) {
          const dropdowns = document.querySelectorAll(".pronoun-dropdown");
          dropdowns.forEach((dropdown, index) => {
            const savedAnswer = partAnswers[partIndex][index];
            if (savedAnswer) {
              const toggle = dropdown.querySelector(".dropdown-toggle");
              toggle.textContent = savedAnswer;
              toggle.classList.add("selected");
              dropdown.setAttribute("data-selected", savedAnswer);
            }
          });
        }
      }

      // Сохранить ответы текущей части
      function saveCurrentAnswers() {
        const dropdowns = document.querySelectorAll(".pronoun-dropdown");
        const answers = [];
        dropdowns.forEach((dropdown) => {
          const selected = dropdown.getAttribute("data-selected");
          answers.push(selected || null);
        });
        partAnswers[currentPartIndex] = answers;
      }

      // Инициализировать dropdown'ы
      function initDropdowns() {
        const dropdownToggles = document.querySelectorAll(".dropdown-toggle");

        dropdownToggles.forEach((toggle) => {
          // Сбрасываем состояние проверки (но сохраняем выбранные ответы)
          toggle.classList.remove("correct", "wrong");

          // Обработчик открытия dropdown
          toggle.addEventListener("click", (e) => {
            e.stopPropagation();
            const dropdown = toggle.nextElementSibling;
            closeAllDropdowns();
            dropdown.classList.add("show");
          });
        });

        const dropdownOptions = document.querySelectorAll(".dropdown-option");
        dropdownOptions.forEach((option) => {
          option.addEventListener("click", (e) => {
            e.stopPropagation();
            const dropdown = option.parentElement;
            const toggle = dropdown.previousElementSibling;
            const selectedValue = option.textContent;

            toggle.textContent = selectedValue;
            toggle.classList.add("selected");
            dropdown.classList.remove("show");

            // Сохраняем выбранный ответ
            const pronounDropdown = toggle.parentElement;
            pronounDropdown.setAttribute("data-selected", selectedValue);

            // Сохраняем ответы текущей части
            saveCurrentAnswers();
          });
        });
      }

      // Закрыть все dropdown'ы
      function closeAllDropdowns() {
        document.querySelectorAll(".dropdown-menu").forEach((menu) => {
          menu.classList.remove("show");
        });
      }

      // Обновить кнопки навигации
      function updateNavigationButtons() {
        const story = storiesData[currentStoryId];

        // Кнопка "Назад"
        backButton.disabled = currentPartIndex === 0;

        // Кнопка "Далее"
        if (currentPartIndex === story.parts.length - 1) {
          nextButton.textContent = "Завершить";
        } else {
          nextButton.textContent = "Далее";
        }
      }

      // Перейти к предыдущей части
      function goToPreviousPart() {
        if (currentPartIndex > 0) {
          // Сохраняем ответы текущей части перед переходом
          saveCurrentAnswers();

          currentPartIndex--;
          loadPart(currentPartIndex);
        }
      }

      // Перейти к следующей части
      function goToNextPart() {
        const story = storiesData[currentStoryId];

        // Сохраняем ответы текущей части
        saveCurrentAnswers();

        // Проверяем ответы текущей части
        const currentPart = story.parts[currentPartIndex];
        const dropdowns = document.querySelectorAll(".pronoun-dropdown");
        let partScore = 0;

        dropdowns.forEach((dropdown, index) => {
          const selected = dropdown.getAttribute("data-selected");
          const correct = dropdown.getAttribute("data-correct");
          const toggle = dropdown.querySelector(".dropdown-toggle");

          if (selected) {
            totalAnswers++;
            if (selected === correct) {
              partScore++;
              toggle.classList.add("correct");
            } else {
              toggle.classList.add("wrong");
              // Сохраняем ошибку
              mistakes.push({
                part: currentPartIndex,
                sentence: currentPart.text,
                userAnswer: selected,
                correctAnswer: correct,
                index: index,
              });
            }
          }
        });

        score += partScore;
        currentPartIndex++;
        loadPart(currentPartIndex);
      }

      // Обновить точки прогресса
      function updateProgressDots(index) {
        const dots = document.querySelectorAll(".progress-dot");
        dots.forEach((dot, i) => {
          dot.classList.remove("current");
          if (i === index) {
            dot.classList.add("current");
          }
        });
      }

      // Показать результаты
      function showResults() {
        const percentage = (score / totalAnswers) * 100;

        if (percentage === 100) {
          resultTitle.textContent = "Отлично!";
          resultTitle.style.color = "#4CAF50";
        } else if (percentage >= 70) {
          resultTitle.textContent = "Хорошо!";
          resultTitle.style.color = "#FF9800";
        } else {
          resultTitle.textContent = "Попробуй еще!";
          resultTitle.style.color = "#F44336";
        }

        resultStats.textContent = `${score} из ${totalAnswers} правильных ответов`;

        // Показываем ошибки, если они есть
        if (mistakes.length > 0) {
          mistakesList.style.display = "block";
          mistakesContainer.innerHTML = "";

          mistakes.forEach((mistake, index) => {
            const mistakeItem = document.createElement("div");
            mistakeItem.className = "mistake-item";

            // Создаем понятное отображение ошибки
            const originalSentence =
              storiesData[currentStoryId].parts[mistake.part].text;

            // Убираем HTML теги для чистого текста
            const cleanSentence = originalSentence.replace(/<[^>]*>/g, "");

            // Находим позицию пропуска в тексте
            const dropdowns = originalSentence.match(
              /<span class='pronoun-dropdown'.*?<\/span>/g
            );
            let sentenceStart = cleanSentence;

            // Заменяем все пропуски на правильные ответы, кроме ошибочного
            dropdowns.forEach((dropdown, i) => {
              const correctAnswer = dropdown.match(/data-correct='(.*?)'/)[1];
              if (i === mistake.index) {
                // Для ошибочного пропуска показываем сравнение
                sentenceStart = sentenceStart.replace("_____", `_____`);
              } else {
                sentenceStart = sentenceStart.replace("_____", correctAnswer);
              }
            });

            mistakeItem.innerHTML = `
                        <div class="mistake-sentence">${sentenceStart}</div>
                        <div class="answer-comparison">
                            <span class="answer-label">Твой ответ:</span>
                            <span class="mistake-user-answer">${mistake.userAnswer}</span>
                            <span class="answer-label">Правильный ответ:</span>
                            <span class="mistake-answer">${mistake.correctAnswer}</span>
                        </div>
                    `;

            mistakesContainer.appendChild(mistakeItem);
          });
        } else {
          mistakesList.style.display = "none";
        }

        resultOverlay.style.display = "flex";
      }

      // Повторить историю
      function retryStory() {
        resultOverlay.style.display = "none";
        startStory(currentStoryId);
      }

      // Вернуться в меню
      function goToMenu() {
        resultOverlay.style.display = "none";
        gameScreen.style.display = "none";
        levelSelectScreen.style.display = "block";
      }

      // Запуск игры при загрузке страницы
      window.addEventListener("DOMContentLoaded", initGame);
    </script>
  </body>
</html>
